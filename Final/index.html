<html>
  <head>
    <title>Chicago's Spatial Mismatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://skeate.dev/Leaflet.timeline/examples/leaflet.timeline.js"></script>
    <script src="https://dsps.lib.uiowa.edu/placing/public/fuse-1.2.1/fuse.min.js"></script>
    <script src="https://dsps.lib.uiowa.edu/placing/public/leafletFuseSearch-noVersion/leafletfuse.js"></script>
    <link rel="stylesheet"href="https://dsps.lib.uiowa.edu/placing/public/leafletFuseSearch-noVersion/leafletfuse.css" type="text/css"/>
    <script src="https://Ldepablo11.github.io/Final/Mismatch.js"></script>
    <style>
      html,
      body {
	      margin: 0;
	      padding: 0;
      }
      #map {
	      width: 100vw;
	      height: 100vh;
      }
      .leaflet-bottom.leaflet-left {
	      width: 100%;
      }
      .leaflet-control-container .leaflet-timeline-controls {
	      box-sizing: border-box;
	      width: 100%;
	      margin: 0;
	      margin-bottom: 15px;
      }
      .opacity-control {
	      position: absolute;
	      bottom: 10px;
	      right: 10px;
	      padding: 6px 8px;
	      font: 14px/16px Arial, Helvetica, sans-serif;
	      background: white;
	      background: rgba(255, 255, 255, 0.8);
	      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
	      border-radius: 5px;
	      width: 200px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var background =
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
	});
      
      var map = L.map("map", {
	      layers: [background],
	      center: new L.LatLng(41.76267620290796, -87.58033286917859),
	      zoom: 11,
      });

      var variables = {
	      "Data_DP03": "Unemployment Rate",
	      "Data_DP_01": "Share of Public Transit Commuters",
	      "Data_index": "Vulnerability Index"
      };
	    
      var opacityControl = L.control({position: 'bottomright'});
	    
      opacityControl.onAdd = function (map) {
	      var div = L.DomUtil.create('div', 'leaflet-bar opacity-control');
	      div.innerHTML = '<h4>Select Opacity Variable:</h4>';
	      for (var variable in variables) {
		      div.innerHTML += '<input type="radio" name="opacity" value="' + variable + '"> ' + variables[variable] + '<br>';
	      }
	      
	      div.addEventListener('change', function (e) {
		      var selectedVariable = e.target.value;
		      updateOpacity(selectedVariable);
	      });
	      return div;
      };
	    
      opacityControl.addTo(map);
      
      var selectedVariable = 'Data_index';

      function updateOpacity(variable) {
	      selectedVariable = variable;
	      chicago.setStyle(style);
      }

      function style(feature) {
	      var opacityProperty;
	      if (selectedVariable === 'Data_DP03') {
		      opacityProperty = feature.properties.Data_DP03 / 100;
	      } else if (selectedVariable === 'Data_DP_01') {
		      opacityProperty = feature.properties.Data_DP_01 / 100;
	      } else if (selectedVariable === 'Data_index') {
		      opacityProperty = feature.properties.Data_index;
	      }
	      
	      return {
		      fillColor: "#000C66",
		      weight: 2,
		      opacity: 1,
		      color: 'black',
		      fillOpacity: opacityProperty
	      };
      }

      function bindPopup(layer, properties) {
	      var content = '<h3>Census Tract ' + properties.Data_name10 + '</h3>';
	      if (properties.Data_DP03 === 0 && properties.Data_DP_01 === 0 && properties.Data_index === 0) {
		      content += '<p>Insufficient data</p>';
	      } else {
		      content += '<p>' +
			      'Unemployment Rate: <strong>' + properties.Data_DP03 + '%</strong><br>' +
			      'Share of Public Transit Commuters: <strong>' + properties.Data_DP_01 + '%</strong><br>' +
			      'Vulnerability Index: <strong>' + properties.Data_index + '</strong></p>';
	      }
	      layer.bindPopup(content);
      }

      function onEachFeature(feature, layer) {
	      if (feature.properties) {
		      bindPopup(layer, feature.properties);
		      layer.on('click', function () {
			      layer.openPopup();
		      });
	      }
      }
	    
      var chicago = new L.geoJson(transit, {
	      style: style,
      	      onEachFeature: onEachFeature
      }).addTo(map);

      var searchLayer = L.geoJson(transit, {
	      onEachFeature: onEachFeature
      });

      var searchOptions = {
	      position: 'topleft',
	      title: 'Search',
	      placeholder: 'Search by Census Tract Name',
	      maxResultLength: 10,
	      caseSensitive: false,
	      showInvisibleFeatures: true,
	      layerToToggle: searchLayer,
	      threshold: 0.5,
	      showResultFct: function(feature, container) {
		      var props = feature.properties;
		      var name = L.DomUtil.create('b', null, container);
		      name.innerHTML = props.Data_name10;
		      container.appendChild(L.DomUtil.create('br', null, container));
		      var dp03 = L.DomUtil.create('div', null, container);
		      dp03.innerHTML = 'Unemployment Rate: ' + (props.Data_DP03 ? props.Data_DP03 + '%' : 'N/A');
		      var dp01 = L.DomUtil.create('div', null, container);
		      dp01.innerHTML = 'Public Transit Commuters: ' + (props.Data_DP_01 ? props.Data_DP_01 + '%' : 'N/A');
		      var index = L.DomUtil.create('div', null, container);
		      dp01.innerHTML = 'Vulnerability Index: ' + (props.Data_index ? props.Data_index : 'N/A');
	      }
      };

      var searchControl = L.control.fuseSearch(searchOptions);

      map.addControl(searchControl);

      searchControl.indexFeatures(transit, ['properties.Data_name10']);

    </script>
  </body>
</html>
